<!doctype html>
<html lang="ja">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Word Quiz (CSV Wordle)</title>
	<style>
		:root{
			--bg:#0f1115;
			--panel:#171a21;
			--text:#e8eaf0;
			--muted:#9aa3b2;
			--line:#2a2f3a;
			--ok:#2ea043;
			--hit:#d29922;
			--no:#6b7280;
			--cell:#11141b;
			--cellText:#e8eaf0;
			--focus:#3b82f6;
		}
		*{box-sizing:border-box}
		body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", sans-serif;background:var(--bg);color:var(--text)}
		.wrap{max-width:920px;margin:0 auto;padding:20px}
		h1{font-size:20px;margin:0 0 12px 0}
		.panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
		.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
		.row + .row{margin-top:10px}
		label{font-size:13px;color:var(--muted)}
		input[type="file"]{color:var(--text)}
		button{
			background:#232838;
			color:var(--text);
			border:1px solid var(--line);
			border-radius:10px;
			padding:8px 12px;
			cursor:pointer;
			font-size:13px;
		}
		button:hover{border-color:#3a4252}
		button:disabled{opacity:.5;cursor:not-allowed}
		.status{font-size:13px;color:var(--muted)}
		.hint{font-size:13px;color:var(--text);line-height:1.5}
		.hint b{color:var(--muted);font-weight:600}

		.game{margin-top:14px}
		.meta{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
		.meta .left{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
		.pill{font-size:12px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#121520}
		.pill strong{color:var(--text);font-weight:700}

		.grid{margin-top:12px;display:grid;gap:8px;justify-content:flex-start}
		.grid-row{display:grid;gap:8px}
		.cell{
			width:42px;height:42px;
			border-radius:10px;
			border:1px solid var(--line);
			background:var(--cell);
			color:var(--cellText);
			display:flex;align-items:center;justify-content:center;
			font-weight:800;
			letter-spacing:.02em;
			text-transform:none;
			user-select:none;
		}
		.cell.ok{background:color-mix(in srgb, var(--ok) 35%, var(--cell));border-color:color-mix(in srgb, var(--ok) 70%, var(--line))}
		.cell.hit{background:color-mix(in srgb, var(--hit) 35%, var(--cell));border-color:color-mix(in srgb, var(--hit) 70%, var(--line))}
		.cell.no{background:color-mix(in srgb, var(--no) 35%, var(--cell));border-color:color-mix(in srgb, var(--no) 70%, var(--line))}

		.guessbar{margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
		.guessbar input[type="text"]{
			width:260px;
			max-width:100%;
			padding:10px 12px;
			border-radius:10px;
			border:1px solid var(--line);
			background:#0c0f15;
			color:var(--text);
			outline:none;
			font-size:14px;
			text-transform:lowercase;
		}
		.guessbar input[type="text"]:focus{border-color:var(--focus);box-shadow:0 0 0 3px color-mix(in srgb, var(--focus) 25%, transparent)}
		.candidates{
			margin-top:10px;
			display:block;
		}
		.cand-list{
			margin:0;
			padding:0;
			list-style:none;
			display:grid;
			gap:6px;
			max-width:260px;
		}
		.cand{
			width:100%;
			padding:8px 10px;
			border-radius:10px;
			border:1px solid var(--line);
			background:#0c0f15;
			color:var(--text);
			font-size:13px;
			text-align:center;
			user-select:none;
			cursor:pointer;
		}
		.cand.sel{
			border-color:var(--focus);
			box-shadow:0 0 0 3px color-mix(in srgb, var(--focus) 25%, transparent);
		}
		.msg{margin-top:10px;font-size:13px;color:var(--muted)}
		.msg.error{color:#fca5a5}
		.msg.success{color:#86efac}

		.kbd{
			margin-top:10px;
			display:grid;
			gap:6px;
			max-width:620px;
		}
		.kbd-row{display:flex;gap:6px;flex-wrap:wrap}
		.k{
			min-width:34px;
			padding:8px 10px;
			border-radius:10px;
			border:1px solid var(--line);
			background:#0c0f15;
			color:var(--text);
			font-size:12px;
			text-transform:none;
			text-align:center;
			user-select:none;
			cursor:pointer;
		}
		.k.ok{background:color-mix(in srgb, var(--ok) 25%, #0c0f15)}
		.k.hit{background:color-mix(in srgb, var(--hit) 25%, #0c0f15)}
		.k.no{background:color-mix(in srgb, var(--no) 25%, #0c0f15)}
		.k.wide{min-width:78px}
		.footer{margin-top:14px;color:var(--muted);font-size:12px;line-height:1.6}
		.footer code{background:#0c0f15;border:1px solid var(--line);padding:2px 6px;border-radius:6px;color:var(--text)}
		#rulePanel label{display:inline-flex;align-items:center;gap:4px;font-size:13px;color:var(--text);cursor:pointer}
		#rulePanel input[type="checkbox"]{accent-color:var(--focus);width:16px;height:16px}
		.modal-overlay{
			position:fixed;
			top:0;left:0;right:0;bottom:0;
			background:rgba(0,0,0,0.7);
			display:flex;
			align-items:center;
			justify-content:center;
			z-index:1000;
		}
		.modal-content{
			background:var(--panel);
			border:1px solid var(--line);
			border-radius:16px;
			padding:24px 32px;
			max-width:400px;
			width:90%;
			text-align:center;
		}
		.modal-title{
			font-size:20px;
			font-weight:700;
			margin-bottom:12px;
		}
		.modal-title.success{color:#86efac}
		.modal-title.error{color:#fca5a5}
		.modal-answer{
			font-size:28px;
			font-weight:800;
			margin:12px 0;
			letter-spacing:0.05em;
		}
		.modal-desc{
			font-size:14px;
			color:var(--muted);
			line-height:1.6;
			margin:12px 0;
		}
		.modal-btn{
			margin-top:16px;
			padding:10px 24px;
			font-size:14px;
		}
		.modal-btns{
			display:flex;
			gap:10px;
			justify-content:center;
			flex-wrap:wrap;
			margin-top:16px;
		}
		.modal-btns .modal-btn{
			margin-top:0;
		}
	</style>
</head>
<body>
	<div class="wrap">
		<h1>Word Quizï¼ˆCSV Wordleï¼‰</h1>

		<div class="panel">
			<div class="row">
				<button id="loadBtn">CSVå†èª­ã¿è¾¼ã¿</button>
				<button id="newBtn" disabled>æ–°ã—ã„å•é¡Œ</button>
				<button id="ruleBtn">ãƒ«ãƒ¼ãƒ«è¨­å®š</button>
				<span id="status" class="status">quizzes.csv æœªèª­è¾¼</span>
			</div>
			<div class="row" id="rulePanel" style="display:none">
				<label>é›£æ˜“åº¦ãƒ•ã‚£ãƒ«ã‚¿:</label>
				<label><input type="checkbox" id="diff1" checked /> 1 <span id="count1" class="status"></span></label>
				<label><input type="checkbox" id="diff2" checked /> 2 <span id="count2" class="status"></span></label>
				<label><input type="checkbox" id="diff3" checked /> 3 <span id="count3" class="status"></span></label>
				<label><input type="checkbox" id="diff4" checked /> 4 <span id="count4" class="status"></span></label>
				<label><input type="checkbox" id="diff5" checked /> 5 <span id="count5" class="status"></span></label>
				<span id="filteredCount" class="status"></span>
			</div>
			<div class="row">
				<div id="hint" class="hint" style="display:none"></div>
			</div>

			<div class="game" id="game" style="display:none">
				<div class="meta">
					<div class="left">
						<div class="pill">æ–‡å­—æ•°: <strong id="len">-</strong></div>
						<div class="pill">æ®‹ã‚Š: <strong id="left">-</strong></div>
					</div>
					<div class="pill">ãƒ’ãƒ³ãƒˆ: <span style="color:var(--muted)">description ã‚’è¡¨ç¤ºä¸­</span></div>
				</div>

				<div id="grid" class="grid" aria-label="guesses"></div>

				<div class="guessbar">
					<input id="guess" type="text" inputmode="text" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦Enter" disabled />
					<button id="submitBtn" disabled>åˆ¤å®š</button>
					<button id="giveUpBtn" disabled>ã‚®ãƒ–ã‚¢ãƒƒãƒ—</button>
				</div>
				<div id="candidates" class="candidates" style="display:none" aria-label="candidates"></div>
				<div id="msg" class="msg"></div>

				<div class="kbd" aria-label="keyboard">
					<div class="kbd-row" id="kbd1"></div>
					<div class="kbd-row" id="kbd2"></div>
					<div class="kbd-row" id="kbd3"></div>
                    <div class="kbd-row" id="kbd4"></div>
				</div>

				<div class="footer">
					- ãƒ«ãƒ¼ãƒ«ã¯WordleåŒæ§˜ï¼ˆä½ç½®ã‚‚ä¸€è‡´=ç·‘ã€å«ã¾ã‚Œã‚‹=é»„ã€å«ã¾ã‚Œãªã„=ç°ï¼‰
					<br />
					- æ–‡å­—æ•°ã¯CSVã® <code>word</code> ã«åˆã‚ã›ã¦è‡ªå‹•èª¿æ•´
				</div>
			</div>
		</div>
	</div>

	<div id="resultModal" class="modal-overlay" style="display:none">
		<div class="modal-content">
			<div id="modalTitle" class="modal-title"></div>
			<div id="modalAnswer" class="modal-answer"></div>
			<div id="modalDesc" class="modal-desc"></div>
			<div class="modal-btns">
				<button id="modalShareBtn" class="modal-btn">ğŸ“ å…±æœ‰</button>
				<button id="modalCloseBtn" class="modal-btn">æ¬¡ã®å•é¡Œã¸</button>
			</div>
		</div>
	</div>

	<script>
		/**
		 * Minimal CSV parser (supports quoted fields and commas/newlines inside quotes).
		 */
		function parseCsv(text){
			const rows = [];
			let row = [];
			let field = '';
			let i = 0;
			let inQuotes = false;

			const pushField = () => {
				row.push(field);
				field = '';
			};
			const pushRow = () => {
				// ignore completely empty trailing lines
				const allEmpty = row.every(v => (v ?? '').trim() === '');
				if(!allEmpty) rows.push(row);
				row = [];
			};

			while(i < text.length){
				const c = text[i];
				if(inQuotes){
					if(c === '"'){
						const next = text[i+1];
						if(next === '"'){ // escaped quote
							field += '"';
							i += 2;
							continue;
						}
						inQuotes = false;
						i++;
						continue;
					}
					field += c;
					i++;
					continue;
				}
				if(c === '"'){
					inQuotes = true;
					i++;
					continue;
				}
				if(c === ','){
					pushField();
					i++;
					continue;
				}
				if(c === '\r'){
					// ignore CR
					i++;
					continue;
				}
				if(c === '\n'){
					pushField();
					pushRow();
					i++;
					continue;
				}
				field += c;
				i++;
			}
			pushField();
			pushRow();
			return rows;
		}

		function toGraphemes(s){
			// Best-effort: spread by code points. (Good enough for English and most inputs.)
			return [...String(s ?? '')];
		}

		function normalizeWord(s){
			// Keep as-is except trimming. Use lowercase for Latin letters.
			return String(s ?? '').trim().toLowerCase();
		}

		function insertAtCursor(inputEl, text){
			const start = inputEl.selectionStart ?? inputEl.value.length;
			const end = inputEl.selectionEnd ?? inputEl.value.length;
			const before = inputEl.value.slice(0, start);
			const after = inputEl.value.slice(end);
			inputEl.value = before + text + after;
			const nextPos = start + text.length;
			inputEl.setSelectionRange(nextPos, nextPos);
			inputEl.dispatchEvent(new Event('input', { bubbles: true }));
		}

		let candidateState = null; // { options: string[], index: number }

		function hideCandidates(){
			candidateState = null;
			if(el.candidates){
				el.candidates.style.display = 'none';
				el.candidates.innerHTML = '';
			}
		}

		function renderCandidates(){
			if(!candidateState || !el.candidates) return;
			el.candidates.innerHTML = '';

			const list = document.createElement('ul');
			list.className = 'cand-list';
			list.setAttribute('role', 'listbox');

			candidateState.options.forEach((opt, idx) => {
				const li = document.createElement('li');
				li.setAttribute('role', 'option');
				li.setAttribute('aria-selected', String(idx === candidateState.index));

				const b = document.createElement('div');
				b.className = 'cand' + (idx === candidateState.index ? ' sel' : '');
				b.textContent = opt;
				b.addEventListener('mousedown', (e) => {
					// prevent input blur
					e.preventDefault();
				});
				b.addEventListener('click', () => {
					if(el.guess.disabled) return;
					commitCandidate(idx);
				});

				li.appendChild(b);
				list.appendChild(li);
			});

			el.candidates.appendChild(list);
		}

		function showCandidates(options, preferredIndex = 0){
			if(!el.candidates) return;
			candidateState = {
				options: options.map(v => normalizeWord(v)),
				index: Math.max(0, Math.min(options.length - 1, preferredIndex)),
			};
			renderCandidates();
			el.candidates.style.display = '';
		}

		function cycleCandidate(delta){
			if(!candidateState) return;
			const n = candidateState.options.length;
			candidateState.index = (candidateState.index + delta + n) % n;
			renderCandidates();
		}

		function commitCandidate(indexOverride = null){
			if(!candidateState) return;
			const idx = indexOverride == null ? candidateState.index : indexOverride;
			const ch = candidateState.options[idx];
			hideCandidates();
			const currentValue = normalizeWord(el.guess.value);
			if(toGraphemes(currentValue).length >= answerChars.length){
				el.guess.focus();
				return;
			}
			insertAtCursor(el.guess, ch);
			el.guess.focus();
		}

		/** Wordle scoring with duplicates handling */
		function scoreGuess(answerChars, guessChars){
			const n = answerChars.length;
			const res = Array(n).fill('no');
			const counts = new Map();
			for(let i=0;i<n;i++){
				const a = answerChars[i];
				counts.set(a, (counts.get(a) ?? 0) + 1);
			}

			// First pass: exact matches
			for(let i=0;i<n;i++){
				if(guessChars[i] === answerChars[i]){
					res[i] = 'ok';
					counts.set(answerChars[i], counts.get(answerChars[i]) - 1);
				}
			}
			// Second pass: present elsewhere
			for(let i=0;i<n;i++){
				if(res[i] === 'ok') continue;
				const g = guessChars[i];
				const left = counts.get(g) ?? 0;
				if(left > 0){
					res[i] = 'hit';
					counts.set(g, left - 1);
				}
			}
			return res;
		}

			const el = {
			loadBtn: document.getElementById('loadBtn'),
			newBtn: document.getElementById('newBtn'),
			ruleBtn: document.getElementById('ruleBtn'),
			rulePanel: document.getElementById('rulePanel'),
			filteredCount: document.getElementById('filteredCount'),
			diff1: document.getElementById('diff1'),
			diff2: document.getElementById('diff2'),
			diff3: document.getElementById('diff3'),
			diff4: document.getElementById('diff4'),
			diff5: document.getElementById('diff5'),
			count1: document.getElementById('count1'),
			count2: document.getElementById('count2'),
			count3: document.getElementById('count3'),
			count4: document.getElementById('count4'),
			count5: document.getElementById('count5'),
			status: document.getElementById('status'),
			hint: document.getElementById('hint'),
			game: document.getElementById('game'),
			len: document.getElementById('len'),
			left: document.getElementById('left'),
			grid: document.getElementById('grid'),
			guess: document.getElementById('guess'),
			submitBtn: document.getElementById('submitBtn'),
			giveUpBtn: document.getElementById('giveUpBtn'),
			msg: document.getElementById('msg'),
			candidates: document.getElementById('candidates'),
			kbd1: document.getElementById('kbd1'),
			kbd2: document.getElementById('kbd2'),
			kbd3: document.getElementById('kbd3'),
            kbd4: document.getElementById('kbd4'),
			resultModal: document.getElementById('resultModal'),
			modalTitle: document.getElementById('modalTitle'),
			modalAnswer: document.getElementById('modalAnswer'),
			modalDesc: document.getElementById('modalDesc'),
			modalShareBtn: document.getElementById('modalShareBtn'),
			modalCloseBtn: document.getElementById('modalCloseBtn'),
		};

		let allEntries = []; // {word, description, abbreviation, difficulty}
		let entries = []; // filtered by difficulty
		let current = null; // {word, description, abbreviation, difficulty}
		let answerChars = [];
		let maxTries = 6;
		let turn = 0;
		let over = false;
		let lastResult = null; // { success, answer, description, turns, maxTries }
		const keyState = new Map(); // letter -> ok/hit/no

		function setStatus(text){
			el.status.textContent = text;
		}

		function setMsg(text, kind = ''){
			el.msg.textContent = text;
			el.msg.className = 'msg' + (kind ? ' ' + kind : '');
		}

		function enableGameUI(enabled){
			el.guess.disabled = !enabled;
			el.submitBtn.disabled = !enabled;
			el.giveUpBtn.disabled = !enabled;
		}

		function clearKeyboard(){
			keyState.clear();
			renderKeyboard();
		}

		function renderKeyboard(){
			const rows = [
				['q','w','e','r','t','y','u','i','o','p'],
				['a','s','d','f','g','h','j','k','l','BKSP'],
				['z','x','c','v','b','n','m','ENTER'],
                ['Ã¤','Ã¶','Ã¼','Ã«','Ã¯','ÃŸ','Ã©','Ã¨','Ã ','Ã¹','Ã¢','Ãª','Ã®','Ã´','Ã»','Ã§','\'','-'],
			];
			const targets = [el.kbd1, el.kbd2, el.kbd3, el.kbd4];
			targets.forEach(t => t.innerHTML = '');

			rows.forEach((r, idx) => {
				r.forEach(k => {
					const b = document.createElement('div');
					b.className = 'k' + ((k === 'ENTER' || k === 'BKSP') ? ' wide' : '');
					b.textContent = k === 'BKSP' ? 'âŒ«' : (k === 'ENTER' ? 'Enter' : k);

					const state = keyState.get(k);
					if(state) b.classList.add(state);

					b.addEventListener('click', () => {
						if(el.guess.disabled) return;
						if(k === 'ENTER'){
							submitGuess();
							return;
						}
						if(k === 'BKSP'){
							el.guess.value = el.guess.value.slice(0, -1);
							el.guess.focus();
							return;
						}
						// regular letter
						const currentValue = normalizeWord(el.guess.value);
						if(toGraphemes(currentValue).length >= answerChars.length) return;
						el.guess.value = currentValue + k;
						el.guess.focus();
					});

					targets[idx].appendChild(b);
				});
			});
		}

		function updateKeyboardFromScore(guessChars, score){
			// Priority: ok > hit > no
			const rank = { no: 0, hit: 1, ok: 2 };
			for(let i=0;i<guessChars.length;i++){
				const ch = guessChars[i];
				if(ch === ' ') continue;
				const next = score[i];
				const prev = keyState.get(ch);
				if(!prev || rank[next] > rank[prev]) keyState.set(ch, next);
			}
			renderKeyboard();
		}

		function buildGrid(cols, rows){
			el.grid.innerHTML = '';
			el.grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

			for(let r=0;r<rows;r++){
				const row = document.createElement('div');
				row.className = 'grid-row';
				row.style.gridTemplateColumns = `repeat(${cols}, 42px)`;
				for(let c=0;c<cols;c++){
					const cell = document.createElement('div');
					cell.className = 'cell';
					cell.textContent = '';
					row.appendChild(cell);
				}
				el.grid.appendChild(row);
			}
		}

		function writeRow(rowIndex, guessChars, score){
			const row = el.grid.children[rowIndex];
			if(!row) return;
			for(let i=0;i<answerChars.length;i++){
				const cell = row.children[i];
				const ch = guessChars[i] ?? '';
				cell.textContent = ch;
				cell.classList.remove('ok','hit','no');
				cell.classList.add(score[i]);
			}
		}

		function getSelectedDifficulties(){
			const selected = [];
			if(el.diff1?.checked) selected.push(1);
			if(el.diff2?.checked) selected.push(2);
			if(el.diff3?.checked) selected.push(3);
			if(el.diff4?.checked) selected.push(4);
			if(el.diff5?.checked) selected.push(5);
			return selected;
		}

		function updateFilteredEntries(){
			const selected = getSelectedDifficulties();
			if(selected.length === 0){
				entries = [...allEntries];
			} else {
				entries = allEntries.filter(e => selected.includes(e.difficulty));
			}
			// Per-level counts
			for(let lv = 1; lv <= 5; lv++){
				const countEl = el['count' + lv];
				if(countEl){
					const c = allEntries.filter(e => e.difficulty === lv).length;
					countEl.textContent = `(${c})`;
				}
			}
			if(el.filteredCount){
				el.filteredCount.textContent = `å¯¾è±¡: ${entries.length}ä»¶ / å…¨${allEntries.length}ä»¶`;
			}
			// Disable newBtn if no entries available
			if(el.newBtn){
				el.newBtn.disabled = (allEntries.length === 0 || entries.length === 0);
			}
		}

		function pickRandomEntry(){
			updateFilteredEntries();
			if(entries.length === 0) return null;
			const idx = Math.floor(Math.random() * entries.length);
			return entries[idx];
		}

		function startNewGame(){
			current = pickRandomEntry();
			if(!current){
				setMsg('CSVã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
				return;
			}

			const word = normalizeWord(current.word);
			const chars = toGraphemes(word);
			if(chars.length === 0){
				setMsg('wordãŒç©ºã®è¡ŒãŒã‚ã‚Šã¾ã™', 'error');
				return;
			}

			answerChars = chars;
			maxTries = chars.length;
			turn = 0;
			over = false;
			clearKeyboard();

			el.game.style.display = '';
			el.hint.style.display = '';
			el.hint.innerHTML = `<b>description:</b> ${escapeHtml(String(current.description ?? ''))}`;
			el.len.textContent = String(answerChars.length);
			el.left.textContent = String(maxTries - turn);
			buildGrid(answerChars.length, maxTries);

			el.guess.value = '';
			el.guess.maxLength = answerChars.length * 4; // allow multi-byte input; we validate by graphemes
			el.guess.placeholder = `${answerChars.length}æ–‡å­—ã§å…¥åŠ›ã—ã¦Enter`;

			enableGameUI(true);
			el.guess.focus();
			setMsg('');
		}

		function endGame(success){
			over = true;
			enableGameUI(false);
			const ans = answerChars.join('');
			el.left.textContent = '0';

			// Store result for sharing
			lastResult = {
				success,
				answer: ans,
				description: current?.description ?? '',
				turns: turn,
				maxTries
			};

			// Show result modal
			if(el.resultModal){
				el.modalTitle.textContent = success ? 'æ­£è§£ï¼' : 'çµ‚äº†';
				el.modalTitle.className = 'modal-title ' + (success ? 'success' : 'error');
				el.modalAnswer.textContent = ans;
				el.modalDesc.textContent = current?.description ?? '';
				el.resultModal.style.display = '';
			}
		}

		function submitGuess(){
			if(over) return;
			const raw = el.guess.value;
			const guessWord = normalizeWord(raw);
			const guessChars = toGraphemes(guessWord);

			if(guessChars.length !== answerChars.length){
				setMsg(`${answerChars.length}æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã„ã¾ ${guessChars.length} æ–‡å­—ï¼‰`, 'error');
				return;
			}
			if(guessChars.some(ch => ch.trim() === '')){
				setMsg('ç©ºç™½ã®ã¿ã®æ–‡å­—ã¯ä½¿ãˆã¾ã›ã‚“', 'error');
				return;
			}

			const score = scoreGuess(answerChars, guessChars);
			writeRow(turn, guessChars, score);
			updateKeyboardFromScore(guessChars, score);

			turn++;
			el.left.textContent = String(Math.max(0, maxTries - turn));
			el.guess.value = '';

			const isCorrect = score.every(s => s === 'ok');
			if(isCorrect){
				endGame(true);
				return;
			}
			if(turn >= maxTries){
				endGame(false);
				return;
			}
			setMsg('');
			el.guess.focus();
		}

		function escapeHtml(s){
			return String(s)
				.replaceAll('&', '&amp;')
				.replaceAll('<', '&lt;')
				.replaceAll('>', '&gt;')
				.replaceAll('"', '&quot;')
				.replaceAll("'", '&#39;');
		}

			const CSV_URL = './quizzes.csv';

			async function loadCsvUrl(url){
				const res = await fetch(url, { cache: 'no-store' });
				if(!res.ok){
					throw new Error(`quizzes.csv ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${res.status}ï¼‰`);
				}
				return await res.text();
			}

		function normalizeHeader(s){
			return String(s ?? '').trim().toLowerCase();
		}

			async function handleLoad(){
				setStatus('èª­ã¿è¾¼ã¿ä¸­...');
			setMsg('');
			try{
					const text = await loadCsvUrl(CSV_URL);
				const rows = parseCsv(text);
				if(rows.length < 2) throw new Error('CSVã«ãƒ‡ãƒ¼ã‚¿è¡ŒãŒã‚ã‚Šã¾ã›ã‚“');

				const header = rows[0].map(normalizeHeader);
				const wordIdx = header.indexOf('word');
				const descIdx = header.indexOf('description');
				const abbrIdx = header.indexOf('abbreviation');
				const diffIdx = header.indexOf('difficultylevel');
				if(wordIdx === -1 || descIdx === -1){
					throw new Error('ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ word,description ãŒå¿…è¦ã§ã™');
				}

				const parsed = [];
				for(let i=1;i<rows.length;i++){
					const r = rows[i];
					const w = normalizeWord(r[wordIdx]);
					const d = String(r[descIdx] ?? '').trim();
					const abbr = abbrIdx !== -1 ? String(r[abbrIdx] ?? '').trim() : '';
					const diff = diffIdx !== -1 ? parseInt(r[diffIdx], 10) || 1 : 1;
					if(!w) continue;
					parsed.push({ word: w, description: d, abbreviation: abbr, difficulty: diff });
				}
				if(parsed.length === 0) throw new Error('æœ‰åŠ¹ãªwordãŒã‚ã‚Šã¾ã›ã‚“');

				allEntries = parsed;
				updateFilteredEntries();
				el.newBtn.disabled = false;
					setStatus(`èª­ã¿è¾¼ã¿å®Œäº†: ${allEntries.length}ä»¶ï¼ˆquizzes.csvï¼‰`);
				startNewGame();
			}catch(err){
				entries = [];
				el.newBtn.disabled = true;
				el.game.style.display = 'none';
				el.hint.style.display = 'none';
				setStatus('èª­ã¿è¾¼ã¿å¤±æ•—');
				setMsg(String(err?.message ?? err), 'error');
			}
		}
		el.newBtn.addEventListener('click', () => {
			startNewGame();
		});
		el.ruleBtn.addEventListener('click', () => {
			const panel = el.rulePanel;
			if(panel.style.display === 'none'){
				panel.style.display = '';
				updateFilteredEntries();
			} else {
				panel.style.display = 'none';
			}
		});
		[el.diff1, el.diff2, el.diff3, el.diff4, el.diff5].forEach(cb => {
			if(cb) cb.addEventListener('change', () => {
				updateFilteredEntries();
			});
		});
		el.submitBtn.addEventListener('click', submitGuess);
		el.giveUpBtn.addEventListener('click', () => {
			if(over) return;
			endGame(false);
		});
		el.modalCloseBtn.addEventListener('click', () => {
			el.resultModal.style.display = 'none';
			if(entries.length > 0){
				startNewGame();
			}
		});
		el.modalShareBtn.addEventListener('click', async () => {
			if(!lastResult) return;
			const emoji = lastResult.success ? 'ğŸ‰' : 'ğŸ˜¢';
			const status = lastResult.success ? `${lastResult.turns}/${lastResult.maxTries}å›ã§æ­£è§£ï¼` : `ä¸æ­£è§£...ç­”ãˆ: ${lastResult.answer}`;
			const shareText = `${emoji} Word Quiz ${emoji}\n${status}\nèª¬æ˜: ${lastResult.description}`;
			
			try {
				await navigator.clipboard.writeText(shareText);
				el.modalShareBtn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
				setTimeout(() => {
					el.modalShareBtn.textContent = 'ğŸ“ å…±æœ‰';
				}, 2000);
			} catch(e) {
				console.error('Clipboard copy failed', e);
			}
			
			// Open Discord channel (replace with your channel URL)
			const discordChannelUrl = 'https://discord.com/channels/1181531577373696090/1383762455783542994';
			window.open(discordChannelUrl, '_blank');
		});
		el.guess.addEventListener('keydown', (e) => {
			if(candidateState){
				if(e.key === 'Tab'){
					e.preventDefault();
					cycleCandidate(e.shiftKey ? -1 : 1);
					return;
				}
				if(String(e.key).startsWith('Arrow')){
					e.preventDefault();
					const k = String(e.key);
					if(k === 'ArrowLeft' || k === 'ArrowUp') cycleCandidate(-1);
					else cycleCandidate(1);
					return;
				}
				if(e.key === 'Enter'){
					e.preventDefault();
					commitCandidate();
					return;
				}
				if(e.key === 'Escape'){
					e.preventDefault();
					hideCandidates();
					return;
				}
				// Any other key closes candidate UI
				hideCandidates();
			}

			if(e.key === 'Enter'){
				e.preventDefault();
				submitGuess();
				return;
			}

			// Shift + a/o/u/s => show candidates (Tab / arrows / Enter / click to choose)
			if(e.shiftKey){
				const k = String(e.key ?? '');
				const base = k.length === 1 ? k.toLowerCase() : k;
				const map = {
					a: ['Ã¤','Ã ','Ã¢', 'a'],
					e: ['Ã«','Ã©','Ã¨','Ãª', 'e'],
					i: ['Ã¯','Ã®', 'i'],
					o: ['Ã¶','Ã´', 'o'],
					u: ['Ã¼','Ã¹','Ã»', 'u'],
					s: ['ÃŸ', 's'], // ÃŸ is default for Shift+S
					c: ['Ã§', 'c'],
				};
				if(map[base]){
					e.preventDefault();
					showCandidates(map[base], 0);
					return;
				}
			}
		});

		el.guess.addEventListener('input', () => {
			if(el.guess.disabled) return;
			const normalized = normalizeWord(el.guess.value);
			const limited = toGraphemes(normalized).slice(0, answerChars.length).join('');
			if(el.guess.value !== limited){
				el.guess.value = limited;
			}
		});
		document.addEventListener('keydown', (e) => {
			if(el.guess.disabled) return;
			if(e.key === 'Backspace') return; // handled by input
			if(e.key === 'Enter') return;
			// Keep focus on input so typing works naturally
			if(document.activeElement !== el.guess) el.guess.focus();
		});

		el.guess.addEventListener('blur', () => {
			hideCandidates();
		});

			renderKeyboard();
			// GitHub Pageså‘ã‘: åˆå›ã¯è‡ªå‹•ã§ quizzes.csv ã‚’èª­ã¿è¾¼ã‚€
			handleLoad();
	</script>
</body>
</html>



